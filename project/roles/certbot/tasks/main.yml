---
- name: Install jq
  ansible.builtin.apt:
    name: jq
    state: present

- name: Configure hooks
  block:
  - name: Create /etc/letsencrypt/renewal-hooks/deploy directory
    ansible.builtin.file:
      group: root
      mode: "0755"
      owner: root
      path: /etc/letsencrypt/renewal-hooks/deploy
  - name: Create global configuration file
    ansible.builtin.copy:
      dest: /etc/letsencrypt
      group: "root"
      mode: "0644"
      owner: "root"
      src: etc/letsencrypt/cli.ini
  - name: Create certificate deploy hook
    ansible.builtin.template:
      dest: /etc/letsencrypt/renewal-hooks/deploy
      group: "root"
      mode: "0755"
      owner: "root"
      src: etc/letsencrypt/renewal-hooks/deploy/00-save-in-vault.sh

- name: Install and invoke certbot
  ansible.builtin.include_role:
    name: geerlingguy.certbot
  vars:
    certbot_create_if_missing: true
    certbot_create_method: standalone
    certbot_install_method: snap